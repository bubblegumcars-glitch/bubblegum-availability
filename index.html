<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bubblegum Cars – Staff View</title>
  <style>
    :root{
      --bg:#f4f5f7;
      --card:#ffffff;
      --text:#111;
      --muted:#777;
      --shadow: 0 6px 16px rgba(0,0,0,.10);
      --green:#28a745;
      --red:#dc3545;
      --orange:#f39c12;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    }
    header{ padding:22px 16px 8px; text-align:center; }
    h1{ margin:0; font-size:34px; font-weight:800; letter-spacing:.2px; }
    .controls{ display:flex; justify-content:center; gap:10px; padding:10px 16px 14px; }
    button{ border:none; background:#e9eaee; padding:10px 16px; border-radius:10px; font-weight:700; cursor:pointer; }
    button:active{transform:scale(.99)}
    .wrap{ max-width:1180px; margin:0 auto; padding:0 14px 28px; }
    .car{ background:var(--card); border-radius:16px; box-shadow:var(--shadow); margin:14px 0; overflow:hidden; }
    .carTop{ display:flex; gap:16px; padding:16px; align-items:center; }
    .thumb{ width:110px; height:70px; border-radius:10px; object-fit:cover; background:#ddd; flex:0 0 auto; }
    .meta{ flex:1; min-width:0; }
    .name{ font-size:34px; font-weight:800; margin:0 0 4px; line-height:1.05; }
    .next{ text-align:right; min-width:160px; }
    .next .label{ color:#888; font-weight:800; font-size:18px; line-height:1.1; }
    .next .value{ font-weight:900; font-size:24px; line-height:1.1; }
    .days{ display:grid; grid-template-columns: repeat(4, minmax(0, 1fr)); gap:10px; padding:0 16px 16px; }
    .day{
      border-radius:14px; padding:12px 10px; color:#fff; font-weight:900; text-align:center;
      line-height:1.1; min-height:86px; display:flex; flex-direction:column; justify-content:center;
    }
    .day .top{ font-size:22px; margin-bottom:4px; }
    .day .mid{ font-size:22px; margin-bottom:4px; }
    .day .small{ font-size:18px; font-weight:800; opacity:.95; }
    .green{ background:var(--green); }
    .red{ background:var(--red); }
    .orange{ background:var(--orange); }
    .footer{ text-align:center; color:var(--muted); font-weight:700; padding:12px 0 4px; }
    .error{ background:#fff; border-radius:14px; box-shadow:var(--shadow); padding:14px; margin:14px 0; color:#b00020; font-weight:800; }
    @media (max-width: 860px){
      .name{font-size:28px}
      .days{grid-template-columns: repeat(2, minmax(0, 1fr));}
      .next{min-width:140px}
    }
  </style>
</head>
<body>
  <header>
    <h1>Bubblegum Cars – Staff View</h1>
  </header>

  <div class="controls">
    <button id="refreshBtn">Refresh</button>
  </div>

  <div class="wrap">
    <div id="content"></div>
    <div class="footer" id="updated"></div>
  </div>

<script>
  const content = document.getElementById("content");
  const updated = document.getElementById("updated");
  const refreshBtn = document.getElementById("refreshBtn");

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    })[c]);
  }

  function statusClass(status){
    if (status === "Available") return "green";
    if (status === "Booked") return "red";
    return "orange";
  }

  function renderDay(d){
    const cls = statusClass(d.status);
    const label = esc(d.label || d.date || "");
    const status = esc(d.status);

    if (d.status === "Booked" && d.bookedFrom && d.bookedUntil){
      return `
        <div class="day ${cls}">
          <div class="top">${label}</div>
          <div class="mid">${status}</div>
          <div class="small">From ${esc(d.bookedFrom)} → ${esc(d.bookedUntil)}</div>
        </div>
      `;
    }

    if (d.status === "Heads-up"){
      const back = d.backTime ? `<div class="small">Back ${esc(d.backTime)}</div>` : "";
      const free = d.freeTime ? `<div class="small">Free ${esc(d.freeTime)}</div>` : "";
      return `
        <div class="day ${cls}">
          <div class="top">${label}</div>
          <div class="mid">Booked</div>
          ${back}
          ${free}
        </div>
      `;
    }

    return `
      <div class="day ${cls}">
        <div class="top">${label}</div>
        <div class="mid">${status}</div>
      </div>
    `;
  }

  function renderCar(car){
    const name = esc(car.name);
    const img = esc(car.photo_url || "");
    const next = esc(car.nextAvailable || "");
    const daysHtml = (car.days || []).slice(0,4).map(renderDay).join("");

    return `
      <div class="car">
        <div class="carTop">
          <img class="thumb" src="${img}" alt="${name}" onerror="this.style.visibility='hidden'"/>
          <div class="meta">
            <div class="name">${name}</div>
          </div>
          <div class="next">
            <div class="label">Next available</div>
            <div class="value">${next}</div>
          </div>
        </div>
        <div class="days">
          ${daysHtml}
        </div>
      </div>
    `;
  }

  async function load(){
    content.innerHTML = "";
    updated.textContent = "";

    try{
      const res = await fetch(`/api/availability?days=4&_=${Date.now()}`, { cache: "no-store" });
      const data = await res.json();

      if (!res.ok || data.error){
        content.innerHTML = `<div class="error">${esc(data.error || "Error loading availability")}</div>`;
        return;
      }

      const cars = data.cars || [];
      content.innerHTML = cars.map(renderCar).join("");

      const now = new Date();
      updated.textContent = `Last updated: ${now.toLocaleString()}`;
    }catch(err){
      content.innerHTML = `<div class="error">${esc(err.message || "Network error")}</div>`;
    }
  }

  refreshBtn.addEventListener("click", load);
  load();
</script>
</body>
</html>
