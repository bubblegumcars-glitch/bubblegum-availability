<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Bubblegum Cars — Staff Availability</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #fff;
      color: #111;
      margin: 0;
      padding: 16px;
    }

    h1 {
      margin-bottom: 4px;
    }

    .days {
      display: flex;
      gap: 8px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    button {
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #f5f5f5;
      cursor: pointer;
      font-size: 14px;
    }

    button.active {
      background: #000;
      color: #fff;
      border-color: #000;
    }

    .car {
      border-bottom: 1px solid #eee;
      padding: 12px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .car-name {
      font-weight: 600;
    }

    .status {
      font-size: 14px;
      font-weight: 600;
    }

    .available {
      color: #1b7f3c;
    }

    .booked {
      color: #b00020;
    }

    .upcoming {
      color: #b36b00;
    }
  </style>
</head>

<body>
  <h1>Bubblegum Cars — Staff Availability</h1>
  <div>Today + next 3 days (Brisbane time)</div>

  <div class="days" id="dayButtons"></div>
  <div id="cars">Loading…</div>

  <script>
    const TZ = "Australia/Brisbane";
    const DAYS = 4;

    let apiData;
    let selectedDay = 0;

    function brisbaneDayStart(offsetDays = 0) {
      const now = new Date();
      const dateStr = new Intl.DateTimeFormat("en-CA", {
        timeZone: TZ,
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      }).format(now);

      const d = new Date(dateStr);
      d.setDate(d.getDate() + offsetDays);
      return d;
    }

    function formatDay(d) {
      return d.toLocaleDateString("en-AU", {
        timeZone: TZ,
        weekday: "short",
        day: "numeric",
        month: "short"
      });
    }

    function formatTime(d) {
      return d.toLocaleTimeString("en-AU", {
        timeZone: TZ,
        hour: "numeric",
        minute: "2-digit"
      });
    }

    function buildButtons() {
      const el = document.getElementById("dayButtons");
      el.innerHTML = "";

      for (let i = 0; i < DAYS; i++) {
        const d = brisbaneDayStart(i);
        const btn = document.createElement("button");
        btn.textContent = formatDay(d);
        if (i === selectedDay) btn.classList.add("active");

        btn.onclick = () => {
          selectedDay = i;
          buildButtons();
          render();
        };

        el.appendChild(btn);
      }
    }

    function render() {
      const container = document.getElementById("cars");
      container.innerHTML = "";

      const dayStart = brisbaneDayStart(selectedDay);
      const dayEnd = new Date(dayStart);
      dayEnd.setDate(dayEnd.getDate() + 1);

      apiData.cars.forEach(car => {
        const row = document.createElement("div");
        row.className = "car";

        const name = document.createElement("div");
        name.className = "car-name";
        name.textContent = car.name;

        const status = document.createElement("div");
        status.className = "status";

        const blocks = car.unavailable || [];

        const overlapping = blocks.find(b =>
          new Date(b.from) < dayEnd && new Date(b.till) > dayStart
        );

        if (overlapping) {
          status.textContent = `Booked — returns ${formatTime(new Date(overlapping.till))}`;
          status.classList.add("booked");
        } else {
          const upcoming = blocks.find(b => new Date(b.from) > dayStart);

          if (upcoming && (new Date(upcoming.from) - new Date()) < 24 * 60 * 60 * 1000) {
            status.textContent = `Available — returns ${formatTime(new Date(upcoming.from))}`;
            status.classList.add("upcoming");
          } else {
            status.textContent = "Available";
            status.classList.add("available");
          }
        }

        row.appendChild(name);
        row.appendChild(status);
        container.appendChild(row);
      });
    }

    async function load() {
      const res = await fetch("/api/availability?days=4");
      apiData = await res.json();
      buildButtons();
      render();
    }

    load();
  </script>
</body>
</html>
