<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bubblegum Cars — Staff Availability</title>
  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#555;
      --chip:#f6f6f6; --chip-border:#e6e6e6;
      --card:#fff; --card-border:#e9e9e9;
      --shadow: 0 1px 0 rgba(0,0,0,.04);
      --green:#0a7a2f; --red:#b00020; --amber:#b05a00;
      --radius:18px;
      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--font); }
    .wrap{ max-width:1100px; margin:0 auto; padding:28px 22px 40px; }
    h1{ font-size:46px; margin:0 0 10px; letter-spacing:-.02em; }
    .sub{ font-size:22px; color:var(--muted); margin:0 0 18px; line-height:1.25; }
    .row{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin:16px 0; }
    .btn{
      border:1px solid var(--chip-border);
      background:var(--chip);
      padding:12px 16px;
      border-radius:14px;
      cursor:pointer;
      font-size:16px;
    }
    .chip{
      border:1px solid var(--chip-border);
      background:var(--chip);
      padding:10px 14px;
      border-radius:999px;
      font-size:16px;
      color:#222;
    }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin:10px 0 18px; }
    .tab{
      border:1px solid var(--chip-border);
      background:#fff;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-size:16px;
    }
    .tab.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .card{
      border:1px solid var(--card-border);
      background:var(--card);
      border-radius:22px;
      padding:18px;
      box-shadow: var(--shadow);
    }
    .cardHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      padding:6px 8px 14px;
      border-bottom:1px solid #f0f0f0;
      margin-bottom:10px;
    }
    .cardTitle{
      font-size:40px;
      margin:0;
      letter-spacing:-.02em;
    }
    .noteRight{
      color:#666;
      font-size:14px;
      text-align:right;
      white-space:nowrap;
    }
    table{ width:100%; border-collapse:collapse; }
    th, td{ padding:14px 10px; border-bottom:1px solid #f2f2f2; vertical-align:top; }
    th{ text-align:left; color:#666; font-weight:600; font-size:14px; letter-spacing:.03em; text-transform:none; }
    td{ font-size:18px; }
    .carName{ font-weight:700; font-size:22px; }
    .status{ font-weight:800; font-size:22px; }
    .Available{ color:var(--green); }
    .Booked{ color:var(--red); }
    .Heads-up{ color:var(--amber); }
    .detail{ color:#444; font-size:15px; line-height:1.25; }
    .small{ color:#777; font-size:14px; }
    .errorBox{
      color:#b00020;
      font-weight:800;
      font-size:30px;
      margin-top:12px;
    }
    .loading{ color:#666; font-size:18px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Bubblegum Cars — Staff Availability</h1>
    <p class="sub">
      Shows <b>Today</b> + <b>next 3 days</b> in Brisbane time. Day = midnight-to-midnight.
      Includes a <b>15-minute re-rent buffer</b>. Anyone with the link can view.
    </p>

    <div class="row">
      <button class="btn" id="refreshBtn">Refresh</button>
      <div class="chip">Timezone: Australia/Brisbane</div>
      <div class="chip">Range: 4 days</div>
      <div class="chip">Buffer: 15 minutes</div>
      <div class="chip">View: Available / Booked / Heads-up + times</div>
    </div>

    <div id="statusLine" class="loading">Loading…</div>

    <div class="tabs" id="tabs"></div>

    <div class="card" id="card" style="display:none;">
      <div class="cardHeader">
        <h2 class="cardTitle" id="cardTitle">—</h2>
        <div class="noteRight">Brisbane time • midnight–midnight • 15-min buffer</div>
      </div>
      <table>
        <thead>
          <tr>
            <th style="width:45%;">Car</th>
            <th style="width:20%;">Status</th>
            <th style="width:35%;">Times / Notes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div id="errorBox" class="errorBox" style="display:none;"></div>
  </div>

<script>
  const API_URL = "/api/availability";

  let DATA = null;
  let ACTIVE_DAY = null;

  function $(id){ return document.getElementById(id); }

  function setLoading(msg){
    $("statusLine").style.display = "block";
    $("statusLine").textContent = msg;
  }

  function setError(msg){
    $("errorBox").style.display = "block";
    $("errorBox").textContent = msg;
  }

  function clearError(){
    $("errorBox").style.display = "none";
    $("errorBox").textContent = "";
  }

  function renderTabs(days){
    const tabs = $("tabs");
    tabs.innerHTML = "";
    days.forEach((d) => {
      const btn = document.createElement("button");
      btn.className = "tab" + (d.date === ACTIVE_DAY ? " active" : "");
      btn.textContent = `${d.label} (${d.date})`;
      btn.onclick = () => {
        ACTIVE_DAY = d.date;
        renderTabs(days);
        renderDay();
      };
      tabs.appendChild(btn);
    });
  }

  function renderDay(){
    if (!DATA || !ACTIVE_DAY) return;

    const day = DATA.days.find(d => d.date === ACTIVE_DAY);
    $("card").style.display = "block";
    $("cardTitle").textContent = `${day.label} — ${day.date}`;

    const tbody = $("tbody");
    tbody.innerHTML = "";

    DATA.cars.forEach((car) => {
      const st = car.statuses[ACTIVE_DAY] || { status: "Unknown", detail: "" };

      const tr = document.createElement("tr");

      const tdCar = document.createElement("td");
      tdCar.innerHTML = `<div class="carName">${escapeHtml(car.name || "Unnamed")}</div>`;

      const tdStatus = document.createElement("td");
      tdStatus.innerHTML = `<div class="status ${cssClass(st.status)}">${escapeHtml(st.status)}</div>`;

      const tdDetail = document.createElement("td");
      tdDetail.innerHTML = st.detail
        ? `<div class="detail">${escapeHtml(st.detail)}</div>`
        : `<div class="small">—</div>`;

      tr.appendChild(tdCar);
      tr.appendChild(tdStatus);
      tr.appendChild(tdDetail);

      tbody.appendChild(tr);
    });

    $("statusLine").style.display = "none";
  }

  function cssClass(status){
    if (status === "Available") return "Available";
    if (status === "Booked") return "Booked";
    if (status === "Heads-up") return "Heads-up";
    return "";
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[m]));
  }

  async function load(){
    clearError();
    setLoading("Loading…");

    try{
      const res = await fetch(API_URL, { cache: "no-store" });
      const text = await res.text();
      let data = null;
      try { data = JSON.parse(text); } catch(e){}

      if (!res.ok){
        throw new Error((data && data.error) ? data.error : text);
      }

      DATA = data;
      ACTIVE_DAY = DATA.days[0].date;

      renderTabs(DATA.days);
      renderDay();
    }catch(err){
      $("card").style.display = "none";
      $("tabs").innerHTML = "";
      setError(String(err.message || err));
      $("statusLine").style.display = "none";
    }
  }

  $("refreshBtn").addEventListener("click", load);

  load();
</script>
</body>
</html>
