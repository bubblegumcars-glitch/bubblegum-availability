<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Bubblegum Staff Availability</title>

<style>
  body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:20px; }
  h1 { text-align:center; margin: 10px 0 10px; }
  #app { max-width: 900px; margin: 0 auto; }

  .card { background:#fff; border-radius:12px; padding:15px; margin: 0 0 16px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
  .car-header { display:flex; align-items:center; gap:15px; justify-content:space-between; }
  .left { display:flex; align-items:center; gap:15px; }
  .car-header img { width:120px; height:80px; object-fit:cover; border-radius:8px; background:#eee; }
  .car-title { margin:0; font-size:22px; }

  .right { font-size:14px; color:#444; text-align:right; }
  .right strong { display:block; font-size:13px; color:#777; font-weight:700; letter-spacing:0.3px; }
  .right .time { font-size:16px; font-weight:700; color:#111; }

  .days { display:flex; gap:10px; margin-top:15px; flex-wrap:wrap; }
  .day { flex:1; min-width:120px; padding:10px; border-radius:10px; text-align:center; font-weight:800; color:#fff; }
  .available { background:#28a745; }
  .booked { background:#dc3545; }
  .headsup { background:#ff9800; }

  .day .small { display:block; margin-top:6px; font-size:13px; font-weight:900; opacity:0.98; }
  .day .debug { display:block; margin-top:6px; font-size:11px; font-weight:800; opacity:0.95; line-height:1.15; }

  .muted { color:#666; font-size: 14px; text-align:center; margin-top:10px; }
  .error { background:#fff3f3; border:1px solid #ffd0d0; color:#a10000; padding:12px; border-radius:10px; white-space:pre-wrap; }

  .topbar { display:flex; justify-content:center; gap:10px; margin-bottom:14px; }
  button { padding:10px 14px; border-radius:10px; border:0; cursor:pointer; box-shadow:0 2px 6px rgba(0,0,0,0.08); }
</style>
</head>

<body>
  <h1>Bubblegum Cars – Staff View</h1>

  <div class="topbar">
    <button onclick="load()">Refresh</button>
  </div>

  <div id="app" class="muted">Loading…</div>

<script>
function debugOn() {
  return new URLSearchParams(window.location.search).get('debug') === '1';
}

async function load() {
  const app = document.getElementById('app');
  app.className = 'muted';
  app.textContent = 'Loading…';

  const dbg = debugOn();

  try {
    const url = '/api/availability?cb=' + Date.now() + (dbg ? '&debug=1' : '');
    const res = await fetch(url, { cache: 'no-store' });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); }
    catch { throw new Error('API did not return JSON:\n\n' + text.slice(0, 2000)); }

    if (!res.ok) throw new Error('API error ' + res.status + ':\n\n' + JSON.stringify(data, null, 2));
    if (!data || !Array.isArray(data.cars)) throw new Error('Unexpected API shape:\n\n' + JSON.stringify(data, null, 2));

    app.className = '';
    app.innerHTML = '';

    data.cars.forEach(car => {
      const card = document.createElement('div');
      card.className = 'card';

      const header = document.createElement('div');
      header.className = 'car-header';

      const left = document.createElement('div');
      left.className = 'left';

      const img = document.createElement('img');
      img.src = car.photo_url || '';
      img.alt = car.name || 'Car';

      const titleWrap = document.createElement('div');
      const h2 = document.createElement('h2');
      h2.className = 'car-title';
      h2.textContent = (car.name || '').trim();
      titleWrap.appendChild(h2);

      left.appendChild(img);
      left.appendChild(titleWrap);

      const right = document.createElement('div');
      right.className = 'right';
      if (car.nextAvailable) {
        right.innerHTML = `<strong>Next available</strong><div class="time">${car.nextAvailable}</div>`;
      } else {
        right.innerHTML = `<strong>Status</strong><div class="time">Available now</div>`;
      }

      header.appendChild(left);
      header.appendChild(right);

      const daysDiv = document.createElement('div');
      daysDiv.className = 'days';

      (car.days || []).forEach(d => {
        const dayBox = document.createElement('div');
        dayBox.className = 'day';

        let cls = 'booked';
        if (d.status === 'Available') cls = 'available';
        if (d.status === 'Heads-up') cls = 'headsup';
        if (d.status === 'Booked') cls = 'booked';
        dayBox.classList.add(cls);

        const mainText = (d.status === 'Heads-up') ? 'Booked' : d.status;

        let extra = '';
        if (d.status === 'Heads-up') {
          if (d.backTime) extra += `<span class="small">Back ${d.backTime}</span>`;
          if (d.freeTime) extra += `<span class="small">Free ${d.freeTime}</span>`;
        }

        let debugHtml = '';
        if (dbg && d.debug) {
          debugHtml =
            `<span class="debug">id: ${d.debug.planning_id}</span>` +
            `<span class="debug">stops_at: ${d.debug.stops_at || '-'}</span>` +
            `<span class="debug">reserved_till: ${d.debug.reserved_till || '-'}</span>`;
        }

        dayBox.innerHTML = `
          ${d.label || ''}<br/>
          ${mainText}
          ${extra}
          ${debugHtml}
        `;

        daysDiv.appendChild(dayBox);
      });

      card.appendChild(header);
      card.appendChild(daysDiv);
      app.appendChild(card);
    });

    const foot = document.createElement('div');
    foot.className = 'muted';
    foot.textContent = 'Last updated: ' + new Date().toLocaleString('en-AU') + (dbg ? ' (debug on)' : '');
    app.appendChild(foot);

  } catch (err) {
    app.className = 'error';
    app.textContent = 'Dashboard error:\n\n' + (err?.message || String(err));
  }
}

load();
</script>
</body>
</html>
