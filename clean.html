<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bubblegum Cars â€” Cleaning Schedule</title>
  <style>
    :root {
      --bg: #f4f5f7;
      --card: #ffffff;
      --text: #111;
      --muted: #777;
      --shadow: 0 6px 18px rgba(0,0,0,.08);
      --radius: 18px;
      --priority: #d92f3f;
      --today: #f39a12;
      --done: #2ca340;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      padding: 28px 16px 8px;
      text-align: center;
    }
    h1 {
      margin: 0;
      font-size: clamp(28px, 4vw, 52px);
      letter-spacing: -0.02em;
      font-weight: 800;
    }
    .subtitle {
      color: var(--muted);
      font-size: 18px;
      margin-top: 8px;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 10px 16px 22px;
    }

    button {
      border: 0;
      background: #e9eaee;
      padding: 12px 18px;
      font-weight: 700;
      border-radius: 14px;
      cursor: pointer;
      box-shadow: 0 2px 0 rgba(0,0,0,.06) inset;
    }
    button:hover { filter: brightness(.98); }

    .wrap {
      max-width: 900px;
      margin: 0 auto;
      padding: 0 14px 40px;
    }

    .error {
      margin: 18px auto;
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 18px;
      color: #9c1f2a;
      font-weight: 800;
      border-left: 10px solid var(--priority);
      white-space: pre-wrap;
      overflow-x: auto;
    }

    .section {
      margin: 32px 0;
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 28px;
      font-weight: 800;
      margin: 0;
    }

    .section-badge {
      background: var(--priority);
      color: white;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 16px;
      font-weight: 800;
    }

    .section-badge.today {
      background: var(--today);
    }

    .empty-message {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
      font-size: 20px;
      font-weight: 600;
    }

    .car-card {
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      margin: 16px 0;
      display: grid;
      grid-template-columns: 110px 1fr;
      gap: 18px;
      align-items: center;
    }

    .thumb {
      width: 110px;
      height: 78px;
      object-fit: cover;
      border-radius: 14px;
      background: #eee;
    }

    .car-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .car-name {
      font-size: 36px;
      font-weight: 900;
      letter-spacing: -0.03em;
      margin: 0;
      line-height: 1;
    }

    .car-details {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .detail-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 18px;
      font-weight: 600;
    }

    .detail-label {
      color: var(--muted);
      min-width: 100px;
    }

    .detail-value {
      color: var(--text);
      font-weight: 800;
    }

    .detail-value.urgent {
      color: var(--priority);
    }

    .detail-value.soon {
      color: var(--today);
    }

    .ready-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--done);
      color: white;
      padding: 6px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 800;
      margin-top: 8px;
    }

    .ready-button {
      background: var(--done);
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 12px;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 8px;
    }

    .ready-button:hover {
      filter: brightness(1.1);
      transform: scale(1.02);
    }

    .ready-button:active {
      transform: scale(0.98);
    }

    .ready-button.marked {
      background: #ccc;
      color: #666;
    }

    .car-card.ready {
      border: 3px solid var(--done);
      background: #f0fdf4;
    }

    footer {
      text-align: center;
      color: var(--muted);
      font-weight: 700;
      padding: 10px 0 0;
      font-size: 14px;
    }

    @media (max-width: 640px) {
      h1 { font-size: 28px; }
      .subtitle { font-size: 16px; }
      .section-title { font-size: 24px; }
      
      .car-card {
        grid-template-columns: 80px 1fr;
        gap: 14px;
        padding: 14px;
      }
      
      .thumb {
        width: 80px;
        height: 56px;
      }
      
      .car-name {
        font-size: 28px;
      }
      
      .detail-row {
        font-size: 16px;
      }
      
      .detail-label {
        min-width: 80px;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ§¼ Cleaning Schedule</h1>
    <div class="subtitle">Today's cars to clean</div>
  </header>

  <div class="controls">
    <button id="refreshBtn">Refresh</button>
  </div>

  <div class="wrap">
    <div id="error" class="error" style="display:none;"></div>
    
    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Priority</h2>
        <span class="section-badge" id="priorityCount">0</span>
      </div>
      <div class="subtitle" style="margin-bottom: 16px;">Clean before 9am â€” returned last night</div>
      <div id="priorityCars"></div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Returning Today</h2>
        <span class="section-badge today" id="todayCount">0</span>
      </div>
      <div class="subtitle" style="margin-bottom: 16px;">Cars coming back during the day</div>
      <div id="todayCars"></div>
    </div>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">Tomorrow Morning</h2>
        <span class="section-badge today" id="tomorrowCount">0</span>
      </div>
      <div class="subtitle" style="margin-bottom: 16px;">Cars that returned today + cars returning tomorrow (need cleaning before next rental)</div>
      <div id="tomorrowCars"></div>
    </div>

    <footer id="updated"></footer>
  </div>

  <script>
    const errEl = document.getElementById('error');
    const updatedEl = document.getElementById('updated');
    const refreshBtn = document.getElementById('refreshBtn');
    const priorityCarsEl = document.getElementById('priorityCars');
    const todayCarsEl = document.getElementById('todayCars');
    const tomorrowCarsEl = document.getElementById('tomorrowCars');
    const priorityCountEl = document.getElementById('priorityCount');
    const todayCountEl = document.getElementById('todayCount');
    const tomorrowCountEl = document.getElementById('tomorrowCount');

    // LocalStorage functions for tracking ready-to-clean status
    function getReadyStatus() {
      try {
        const stored = localStorage.getItem('cleaningStatus');
        if (!stored) return {};
        const data = JSON.parse(stored);
        // Clean up old entries (older than 24 hours)
        const now = Date.now();
        const cleaned = {};
        for (const [carId, entry] of Object.entries(data)) {
          if (now - entry.timestamp < 24 * 60 * 60 * 1000) {
            cleaned[carId] = entry;
          }
        }
        localStorage.setItem('cleaningStatus', JSON.stringify(cleaned));
        return cleaned;
      } catch (e) {
        return {};
      }
    }

    function setReadyStatus(carId, ready) {
      try {
        const current = getReadyStatus();
        if (ready) {
          current[carId] = {
            ready: true,
            timestamp: Date.now()
          };
        } else {
          delete current[carId];
        }
        localStorage.setItem('cleaningStatus', JSON.stringify(current));
      } catch (e) {
        console.error('Failed to save status', e);
      }
    }

    function isCarReady(carId) {
      const status = getReadyStatus();
      return status[carId]?.ready || false;
    }

    function setError(msg) {
      errEl.style.display = msg ? 'block' : 'none';
      errEl.textContent = msg || '';
    }

    function parseTime(timeStr) {
      // Parse "HH:MM" format
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours * 60 + minutes;
    }

    function formatTimeRelative(timeStr) {
      const time = parseTime(timeStr);
      const now = new Date();
      const currentMinutes = now.getHours() * 60 + now.getMinutes();
      const diff = time - currentMinutes;

      if (diff < 60) {
        return `${diff} min`;
      }
      const hours = Math.floor(diff / 60);
      return `${hours}h ${diff % 60}m`;
    }

    function createCarCard(car, returnTime, nextRental, label) {
      const card = document.createElement('div');
      card.className = 'car-card';
      
      const isReady = isCarReady(car.id);
      if (isReady) {
        card.classList.add('ready');
      }

      let nextRentalHTML = '';
      if (nextRental) {
        const urgencyClass = parseTime(nextRental) - parseTime(returnTime) < 240 ? 'urgent' : 'soon';
        nextRentalHTML = `
          <div class="detail-row">
            <span class="detail-label">Next rental:</span>
            <span class="detail-value ${urgencyClass}">${nextRental}</span>
          </div>
        `;
      }

      const labelHTML = label ? `
        <div class="detail-row">
          <span class="detail-label">${label}</span>
        </div>
      ` : '';

      const readyButtonHTML = isReady 
        ? '<div class="ready-badge">âœ“ Ready to clean</div>'
        : `<button class="ready-button" data-car-id="${car.id}">Mark as Ready to Clean</button>`;

      card.innerHTML = `
        <img class="thumb" src="${car.photo_url || ''}" alt="${car.name || ''}" />
        <div class="car-info">
          <h3 class="car-name">${car.name || ''}</h3>
          <div class="car-details">
            <div class="detail-row">
              <span class="detail-label">Returned:</span>
              <span class="detail-value">${returnTime}</span>
            </div>
            ${nextRentalHTML}
            ${labelHTML}
          </div>
          ${readyButtonHTML}
        </div>
      `;

      // Add event listener to ready button
      const button = card.querySelector('.ready-button');
      if (button) {
        button.addEventListener('click', function() {
          const carId = this.getAttribute('data-car-id');
          setReadyStatus(carId, true);
          // Re-render to update UI
          load();
        });
      }

      // Add click on badge to unmark
      const badge = card.querySelector('.ready-badge');
      if (badge) {
        badge.style.cursor = 'pointer';
        badge.title = 'Click to unmark';
        badge.addEventListener('click', function() {
          setReadyStatus(car.id, false);
          load();
        });
      }

      return card;
    }

    function render(data) {
      priorityCarsEl.innerHTML = '';
      todayCarsEl.innerHTML = '';
      tomorrowCarsEl.innerHTML = '';

      const now = new Date();
      const currentHour = now.getHours();
      const currentMinutes = now.getMinutes();
      const currentTime = currentHour * 60 + currentMinutes;

      // Get today's and tomorrow's dates
      const todayDate = data.days && data.days[0] ? data.days[0].date : null;
      const tomorrowDate = data.days && data.days[1] ? data.days[1].date : null;

      const priorityCars = [];
      const todayCars = [];
      const tomorrowCars = [];

      for (const car of (data.cars || [])) {
        // Look through the days to find returns
        for (let dayIndex = 0; dayIndex < (car.days || []).length; dayIndex++) {
          const day = car.days[dayIndex];
          
          // Skip if no day or not a heads-up/booked day
          if (!day || day.status === 'Available') continue;

          // Priority: Cars returned yesterday after 6pm (need cleaning ASAP before 9am)
          if (dayIndex === 0 && day.backTime) {
            const backTimeMinutes = parseTime(day.backTime);
            // If returned after 6pm (18:00), it needs cleaning before 9am
            if (backTimeMinutes >= 18 * 60) {
              priorityCars.push({
                car,
                returnTime: day.backTime,
                nextRental: car.days[1]?.bookedFrom || null
              });
            }
          }

          // Returning Today: Cars that haven't returned yet (future returns today)
          if (day.date === todayDate && day.backTime) {
            const backTimeMinutes = parseTime(day.backTime);
            // Only show if it hasn't returned yet
            if (backTimeMinutes > currentTime) {
              todayCars.push({
                car,
                returnTime: day.backTime,
                nextRental: day.freeTime || null
              });
            }
          }

          // Tomorrow Morning: ALL cars that returned today (any time) need cleaning tomorrow
          if (day.date === todayDate && day.backTime) {
            const backTimeMinutes = parseTime(day.backTime);
            // Include ALL cars that returned today (already returned or returning later)
            tomorrowCars.push({
              car,
              returnTime: day.backTime,
              nextRental: car.days[1]?.bookedFrom || null, // Tomorrow's first rental
              label: backTimeMinutes <= currentTime ? 'Returned today' : 'Returns today'
            });
          }

          // Tomorrow Morning: Also include cars returning tomorrow after 6pm
          if (day.date === tomorrowDate && day.backTime) {
            const backTimeMinutes = parseTime(day.backTime);
            // If returning after 6pm tomorrow, will need cleaning the day after
            if (backTimeMinutes >= 18 * 60) {
              tomorrowCars.push({
                car,
                returnTime: day.backTime,
                nextRental: car.days[2]?.bookedFrom || null,
                label: 'Returns tomorrow'
              });
            }
          }
        }
      }

      // Remove duplicates from tomorrow (car might be in there twice)
      const tomorrowCarsUnique = [];
      const seenCarIds = new Set();
      for (const item of tomorrowCars) {
        if (!seenCarIds.has(item.car.id)) {
          seenCarIds.add(item.car.id);
          tomorrowCarsUnique.push(item);
        }
      }

      // Sort by return time
      todayCars.sort((a, b) => parseTime(a.returnTime) - parseTime(b.returnTime));
      tomorrowCarsUnique.sort((a, b) => parseTime(a.returnTime) - parseTime(b.returnTime));

      // Render priority cars
      if (priorityCars.length === 0) {
        priorityCarsEl.innerHTML = '<div class="empty-message">âœ… No cars need urgent cleaning</div>';
      } else {
        for (const item of priorityCars) {
          priorityCarsEl.appendChild(createCarCard(item.car, item.returnTime, item.nextRental, item.label));
        }
      }

      // Render today's cars
      if (todayCars.length === 0) {
        todayCarsEl.innerHTML = '<div class="empty-message">No cars returning later today</div>';
      } else {
        for (const item of todayCars) {
          todayCarsEl.appendChild(createCarCard(item.car, item.returnTime, item.nextRental, item.label));
        }
      }

      // Render tomorrow's cars
      if (tomorrowCarsUnique.length === 0) {
        tomorrowCarsEl.innerHTML = '<div class="empty-message">No cars to clean tomorrow morning</div>';
      } else {
        for (const item of tomorrowCarsUnique) {
          tomorrowCarsEl.appendChild(createCarCard(item.car, item.returnTime, item.nextRental, item.label));
        }
      }

      // Update counts
      priorityCountEl.textContent = priorityCars.length;
      todayCountEl.textContent = todayCars.length;
      tomorrowCountEl.textContent = tomorrowCarsUnique.length;

      const ts = new Date();
      updatedEl.textContent = `Last updated: ${ts.toLocaleString('en-AU')}`;
    }

    async function load() {
      setError('');
      priorityCarsEl.innerHTML = '';
      todayCarsEl.innerHTML = '';
      tomorrowCarsEl.innerHTML = '';
      updatedEl.textContent = '';

      try {
        const res = await fetch('/api/availability', { cache: 'no-store' });
        const json = await res.json();

        if (!res.ok) {
          setError(json?.error || `HTTP ${res.status}`);
          return;
        }

        if (json?.error) {
          setError(json.error);
          return;
        }

        render(json);
      } catch (e) {
        setError(String(e));
      }
    }

    refreshBtn.addEventListener('click', load);
    load();
    
    // Auto-refresh every 2 minutes
    setInterval(load, 120000);
  </script>
</body>
</html>
